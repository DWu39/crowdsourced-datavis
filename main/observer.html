<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <script src="js/lib/d3.v3.min.js"></script>
    <script src="js/generateData.js"></script>
   <script src="/socket.io/socket.io.js"></script>
    <link rel="stylesheet" type="text/css" href="css/styles.css">

    <style>
        .background {
            fill: #eee;
        }

        line {
            stroke: #fff;
        }

        text.active {
            fill: red;
        }

        *{
            font-size: 10px;
        }
    </style>
</head>
<body>
    <div id='matrix'></div>

    <script>
        // ---------- SOCKET.IO and EVENTS ---------- //
        var io = io();

        // TODO: get all other sockets and initialize model
        io.emit('observerConnect', function(data) {
            // store data in model and initialize matrix
        });

        // TODO: receive a draw event
        io.on('drawCircle', function(data) {
            console.log(data);
            // update the model
            // update the matrix
        });

        // TODO: catch new connections
        io.on('newConnection', function(conn) {
            console.log(conn);
        });


        // ---------- CLASSES/HELPERS ---------- //
        function User(id, loc, name, role) {
            this.id = id;
            this.location = loc;
            this.name = name;
            this.role = role;
            this.actions = [];
            this.value = 0;
        };

        User.prototype.addAction = function(action) { this.actions.push(action); }

        function Matrix(data, ordering) {
            this.ordering = ordering;
            this.users = data.users;
            this.links = data.links;

            var matrix = [],
                n = data.numUsers;

            // initialize matrix from top row to bottom row
            for (var i=0; i<n; i++)
                matrix[i] = d3.range(n).map(function(j) { return {x: j, y: i, z: 0}; });

            this.links.forEach(function(link) {
                // filling in only half of triangle, showing a one-sided relationship
                // i.e. user in row i affects users in columns
                matrix[link.source][link.target].z += link.value;
            });

            this.matrix = matrix;
        }

        function computeLinks(data) {
            console.log(data);
            return [];
        }


        // ---------- MVC ---------- //
        var model = {
            // actions per user
            userData: {},

            // holds the current data being shown in view
            viewModel: {
                users: [],
                links: [],
                numUsers: 0
            },

            // starting up/clearing model with fresh data
            init: function(data) {
                this.userData = {};
                this.viewModel = {
                    users: [],
                    links: [],
                    numUsers: 0
                }
                if (data) this.storeInModel(data);
            },

            // reads more data into model
            storeInModel: function(data) {
                for (var i=0; i<data.length; i++) {
                    var d = data[i];
                    if (this.userData[d.id] === undefined) {
                        this.userData[d.id] = new User(d.id, d.location, d.name, d.role);
                    }
                    this.userData[d.id].addAction(d.action);
                };
            },

            // store new data in viewModel
            storeInViewModel: function(data) {
                var data = typeof data === 'undefined' ? this.userData : data; // load all data by default

                var users = [];
                for (var u in data) {
                    if (data.hasOwnProperty(u))
                        users.push(data[u]);
                }

                this.viewModel.users = users;
                this.viewModel.links = computeLinks(data); // recalculates links after reading in new data
                this.viewModel.numUsers = users.length;
            },

            getViewModel: function() { return this.viewModel; }
        };

        var controller = {
            getOrdering: this.orderByName, // order by name by default

            init: function(data) {
                model.init(data);
                view.init();
                this.getOrdering = this.orderByName;
            },

            // feed current viewModel into view
            renderView: function() {
                var data = model.getViewModel();
                if (data.numUsers === 0) console.log('view is empty');
                var ordering = this.getOrdering(data.users);
                var matrix = new Matrix(data, ordering);
                view.render(matrix);
            },

            orderById: function(users) {
                if (users) {
                    return d3.range(users.length).sort(function(a, b) {
                        return d3.ascending(users[a].id, users[b].id);
                    });
                }
                return []
            },

            orderByName: function(users) {
                if (users) {
                    return d3.range(users.length).sort(function(a, b) {
                        return d3.ascending(users[a].name, users[b].name);
                    });
                }
                return []
            },

            setOrdering: function(ordering) { this.getOrdering = ordering; }
        };

        var view = {
            // create new canvas for matrix to be drawn in
            init: function() {
                this.margin = {top: 80, right: 0, bottom: 10, left: 80};
                this.width = 480;
                this.height = 480;
            },

            // draw a new matrix
            render: function(matrix) {
                // remove all previous matrix svgs and create new one
                d3.select('#matrix svg').remove();
                var svg = d3.select('#matrix').append('svg')
                    .attr("width", this.width + this.margin.left + this.margin.right)
                    .attr("height", this.height + this.margin.top + this.margin.bottom)
                    .style("margin-left", this.margin.left + "px")
                    .append("g")
                    .attr("transform", "translate(" + this.margin.left + "," + this.margin.top + ")");

                var x = d3.scale.ordinal().rangeBands([0, this.width]), // scale for the position of user
                    z = d3.scale.linear().clamp(true); // scale for the link strength

                x.domain(matrix.ordering);
                z.domain([0, d3.max(matrix.links, function(link) { return link.value; })]);

                console.log(matrix);

                // draw matrix rows
                var row = svg.selectAll(".row")
                    .data(matrix.matrix).enter()
                    .append("g")
                    .attr("class", "row")
                    .attr("transform", function(d, i) { return "translate(0," + x(i) + ")"; })
                    .each(row);

                row.append("line").attr("x2", this.width);

                row.append("text")
                    .attr("x", -6)
                    .attr("y", x.rangeBand() / 2)
                    .attr("dy", ".32em")
                    .attr("text-anchor", "end")
                    .text(function(d, i) { return matrix.users[i].name; });

                //draw matrix columns
                var column = svg.selectAll(".column")
                    .data(matrix.matrix).enter()
                    .append("g")
                    .attr("class", "column")
                    .attr("transform", function(d, i) { return "translate(" + x(i) + ")rotate(-90)"; });

                column.append("line").attr("x1", -this.width);

                column.append("text")
                      .attr("x", 6)
                      .attr("y", x.rangeBand() / 2)
                      .attr("dy", ".32em")
                      .attr("text-anchor", "start")
                      .text(function(d, i) { return matrix.users[i].name; });

                // fill in row with data and add hover effects
                function row(row) {
                    var cell = d3.select(this).selectAll(".cell")
                        .data(row.filter(function(d) { return d.z; }))
                        .enter().append("rect")
                            .attr("class", "cell")
                            .attr("x", function(d) { return x(d.x); })
                            .attr("width", x.rangeBand())
                            .attr("height", x.rangeBand())
                            .style("fill-opacity", function(d) { return z(d.z); })
                            .on("mouseover", mouseover)
                            .on("mouseout", mouseout);
                }

                function mouseover(p) {
                    d3.selectAll(".row text").classed("active", function(d, i) { return i == p.y; });
                    d3.selectAll(".column text").classed("active", function(d, i) { return i == p.x; });
                }

                function mouseout() {
                    d3.selectAll("text").classed("active", false);
                }
            },
        };


        // ---------- INITIALIZE ---------- //
        controller.init();
        generate.setNumUsers(5);
        generate.setNumObservations(5);
        var data = generate.generateData(false);

        model.storeInModel(data);
        model.storeInViewModel(); // put all da data in view model
        controller.renderView();


        // ---------- FILTERS ---------- //
        (function() {
            var prototype = d3.selection.prototype; // add new methods to the d3 selection prototype

            /**
            * param data - d3 selection of data
            * param str - string to filter by, can also be array of strings
            * param prop - property holding the string
            */
            var filterByString = function(data, str, prop) {
                return data.filter(function(d) {
                    if (typeof str === 'string') return d.action[prop] === str;
                    else return str.indexOf(d.action[prop]) !== -1;
                });
            };

            // TODO: more accurate word count, e.g. disregarding special characters
            var countWords = function(text) { return text.split(' ').length; };

            /**
            * param s - start time
            * param t - end time
            * set s or t to null if you want to disregard
            */
            prototype.slice = function(s, t) {
                if (s > t) return d3.select([]);

                var res = this;
                if (typeof s === 'number' && s >= 0)
                    res = res.filter(function(d) { return d.action.date >= s; });

                if (typeof t === 'number' && t >= 0)
                    res = res.filter(function(d) { return d.action.date <= t; });

                return res;
            };

            /** TODO: not sure if storing in arrays works with D3
            * param len - length of time block
            * param n - first n events per block (optional)
            */
            prototype.block = function(len, n) {
                var blocks = [],
                    curr = [],
                    time = len,
                    data = this.sort(function(a, b) { return d3.ascending(a.action.date, b.action.date); });

                // split data into blocks
                data.each(function(d) {
                    if (d.action.date <= time) {
                        if (typeof n === 'undefined') curr.push(d);
                        else if (curr.length < n) curr.push(d);
                    } else {
                        blocks.push(curr);
                        // shift time block until current event fits
                        while (d.action.date > time) time += len;
                        curr = [d];
                    }
                });
                blocks.push(curr);
                return blocks;
            };

            prototype.filterByRole = function(role) { return filterByString(this, role, 'role'); };

            prototype.filterByLocation = function(loc) { return filterByString(this, loc, 'location'); };

            prototype.filterByText = function(text) {
                var re = new RegExp(text);
                return this.filter(function(d) { return d.action.text.search(re) !== -1; });
            };

            /**
            * param lo - min count
            * param hi - max count
            * set lo or hi to null if you want to disregard
            */
            prototype.filterByWordCount = function(lo, hi) {
                if (lo > hi) return d3.select([]); //TODO: how to return an empty selection?

                var res = this;
                if (typeof lo === 'number' && lo >= 0)
                    res = res.filter(function(d) { return countWords(d.action.text) >= lo; });

                if (typeof hi === 'number' && hi >= 0)
                    res = res.filter(function(d) { return countWords(d.action.text) <= hi; });

                return res;
            };

            /**
            * param id - integer or aray of integers
            */
            prototype.filterById = function(id) {
                return this.filter(function(d) {
                    if (typeof id === 'number') return d.id === id;
                    else return id.indexOf(d.id) !== -1;
                });
            }
        })();


        // ----------- SORTS ----------- //
       (function(){
            var prototype = d3.selection.prototype;

            /**
            * param data - javascript array of objects
            * param prop - object property
            * param asc - ascending sorting or not, true by default
            */
            var sortByString = function(data, prop, asc) {
                var asc = typeof asc !== 'undefined' ? asc : true,
                    f = function(a, b) {
                        if (a.action[prop] > b.action[prop]) return asc ? 1 : -1;
                        if (a.action[prop] < b.action[prop]) return asc ? -1 : 1;
                        else return 0;
                    };
                return data.sort(f);
            };

            prototype.sortByName = function(asc) {
                asc = typeof asc !== 'undefined' ? asc : true;
                return sortByString(this, 'name', asc);
            };

            prototype.sortByLocation = function(asc) {
                asc = typeof asc !== 'undefined' ? asc : true;
                return sortByString(this, 'location', asc);
            }
        })();

    </script>
</body>
</html>



